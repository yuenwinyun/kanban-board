<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kanban Board</title>
<style>
  *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --bg: #0d1117;
    --surface: #161b22;
    --surface-hover: #1c2333;
    --border: #30363d;
    --text: #e6edf3;
    --text-muted: #8b949e;
    --accent: #58a6ff;
    --accent-hover: #79b8ff;
    --danger: #f85149;
    --danger-hover: #ff6e6a;
    --todo: #da3633;
    --progress: #d29922;
    --done: #238636;
    --radius: 10px;
    --shadow: 0 2px 8px rgba(0,0,0,.3);
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  header {
    padding: 20px 32px;
    display: flex;
    align-items: center;
    gap: 12px;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
  }

  header h1 {
    font-size: 1.4rem;
    font-weight: 600;
    letter-spacing: -.02em;
  }

  header .logo {
    width: 28px; height: 28px;
    background: var(--accent);
    border-radius: 6px;
    display: grid; place-items: center;
    font-weight: 700; font-size: .85rem; color: var(--bg);
  }

  .board {
    flex: 1;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    padding: 24px;
    max-width: 1200px;
    width: 100%;
    margin: 0 auto;
  }

  .column {
    background: var(--surface);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    min-height: 300px;
    overflow: hidden;
  }

  .column-header {
    padding: 16px 18px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .column-header .left {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .column-header .dot {
    width: 10px; height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .column[data-col="todo"] .dot { background: var(--todo); }
  .column[data-col="progress"] .dot { background: var(--progress); }
  .column[data-col="done"] .dot { background: var(--done); }

  .column-header h2 {
    font-size: .9rem;
    font-weight: 600;
  }

  .count {
    background: var(--border);
    font-size: .75rem;
    padding: 1px 8px;
    border-radius: 10px;
    color: var(--text-muted);
    font-weight: 500;
  }

  .add-btn {
    background: none;
    border: none;
    color: var(--text-muted);
    font-size: 1.3rem;
    cursor: pointer;
    width: 28px; height: 28px;
    border-radius: 6px;
    display: grid; place-items: center;
    transition: .15s;
    line-height: 1;
  }

  .add-btn:hover {
    background: var(--border);
    color: var(--text);
  }

  .task-list {
    flex: 1;
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    overflow-y: auto;
    min-height: 60px;
  }

  .task-list.drag-over {
    background: rgba(88,166,255,.06);
  }

  .card {
    background: var(--surface-hover);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 14px;
    cursor: grab;
    transition: box-shadow .15s, border-color .15s, opacity .15s;
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 8px;
    user-select: none;
  }

  .card:hover {
    border-color: var(--accent);
    box-shadow: var(--shadow);
  }

  .card.dragging {
    opacity: .4;
  }

  .card-text {
    font-size: .875rem;
    line-height: 1.45;
    word-break: break-word;
    flex: 1;
  }

  .card .delete-btn {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    font-size: .8rem;
    padding: 2px;
    border-radius: 4px;
    opacity: 0;
    transition: .15s;
    flex-shrink: 0;
    line-height: 1;
  }

  .card:hover .delete-btn { opacity: 1; }
  .card .delete-btn:hover { color: var(--danger); }

  .add-form {
    padding: 0 12px 12px;
  }

  .add-form textarea {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    padding: 10px 12px;
    font-size: .875rem;
    font-family: inherit;
    resize: none;
    outline: none;
    line-height: 1.45;
  }

  .add-form textarea:focus {
    border-color: var(--accent);
  }

  .add-form .form-actions {
    display: flex;
    gap: 6px;
    margin-top: 8px;
  }

  .btn {
    padding: 6px 14px;
    border-radius: 6px;
    border: none;
    font-size: .8rem;
    font-weight: 500;
    cursor: pointer;
    transition: .15s;
    font-family: inherit;
  }

  .btn-primary {
    background: var(--accent);
    color: var(--bg);
  }

  .btn-primary:hover { background: var(--accent-hover); }

  .btn-ghost {
    background: none;
    color: var(--text-muted);
  }

  .btn-ghost:hover { color: var(--text); }

  .empty-state {
    color: var(--text-muted);
    font-size: .8rem;
    text-align: center;
    padding: 24px 12px;
  }

  @media (max-width: 768px) {
    .board {
      grid-template-columns: 1fr;
      padding: 16px;
      gap: 16px;
    }
    .column { min-height: 200px; }
    header { padding: 16px 20px; }
  }
</style>
</head>
<body>

<header>
  <div class="logo">K</div>
  <h1>Kanban Board</h1>
</header>

<div class="board">
  <div class="column" data-col="todo">
    <div class="column-header">
      <div class="left">
        <span class="dot"></span>
        <h2>To Do</h2>
        <span class="count">0</span>
      </div>
      <button class="add-btn" title="Add task">+</button>
    </div>
    <div class="task-list" data-col="todo"></div>
  </div>

  <div class="column" data-col="progress">
    <div class="column-header">
      <div class="left">
        <span class="dot"></span>
        <h2>In Progress</h2>
        <span class="count">0</span>
      </div>
      <button class="add-btn" title="Add task">+</button>
    </div>
    <div class="task-list" data-col="progress"></div>
  </div>

  <div class="column" data-col="done">
    <div class="column-header">
      <div class="left">
        <span class="dot"></span>
        <h2>Done</h2>
        <span class="count">0</span>
      </div>
      <button class="add-btn" title="Add task">+</button>
    </div>
    <div class="task-list" data-col="done"></div>
  </div>
</div>

<script>
(function() {
  const API_URL = 'http://192.168.50.218:8081/api/tasks';

  async function load() {
    try {
      const res = await fetch(API_URL);
      return await res.json();
    } catch { return { todo: [], progress: [], done: [] }; }
  }

  async function save(data) {
    try {
      await fetch(API_URL, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
    } catch (e) { console.error('Save failed:', e); }
  }

  let data = { todo: [], progress: [], done: [] };

  load().then(d => {
    data = d;
    renderAll();
  });

  function uid() {
    return Date.now().toString(36) + Math.random().toString(36).slice(2, 7);
  }

  function updateCounts() {
    document.querySelectorAll('.column').forEach(col => {
      const key = col.dataset.col;
      col.querySelector('.count').textContent = data[key].length;
    });
  }

  function createCard(task, colKey) {
    const el = document.createElement('div');
    el.className = 'card';
    el.draggable = true;
    el.dataset.id = task.id;

    const text = document.createElement('span');
    text.className = 'card-text';
    text.textContent = task.text;

    const del = document.createElement('button');
    del.className = 'delete-btn';
    del.title = 'Delete task';
    del.innerHTML = '&#10005;';
    del.addEventListener('click', async () => {
      data[colKey] = data[colKey].filter(t => t.id !== task.id);
      await save(data);
      el.remove();
      updateCounts();
      showEmptyStates();
    });

    el.appendChild(text);
    el.appendChild(del);

    el.addEventListener('dragstart', e => {
      el.classList.add('dragging');
      e.dataTransfer.setData('text/plain', JSON.stringify({ id: task.id, from: colKey }));
      e.dataTransfer.effectAllowed = 'move';
    });

    el.addEventListener('dragend', () => {
      el.classList.remove('dragging');
    });

    return el;
  }

  function showEmptyStates() {
    document.querySelectorAll('.task-list').forEach(list => {
      const key = list.dataset.col;
      let empty = list.querySelector('.empty-state');
      if (data[key].length === 0) {
        if (!empty) {
          empty = document.createElement('div');
          empty.className = 'empty-state';
          empty.textContent = 'No tasks yet';
          list.appendChild(empty);
        }
      } else if (empty) {
        empty.remove();
      }
    });
  }

  function renderAll() {
    document.querySelectorAll('.task-list').forEach(list => {
      const key = list.dataset.col;
      list.innerHTML = '';
      data[key].forEach(task => list.appendChild(createCard(task, key)));
    });
    updateCounts();
    showEmptyStates();
  }

  // Drag and drop on task lists
  document.querySelectorAll('.task-list').forEach(list => {
    list.addEventListener('dragover', e => {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      list.classList.add('drag-over');
    });

    list.addEventListener('dragleave', e => {
      if (!list.contains(e.relatedTarget)) {
        list.classList.remove('drag-over');
      }
    });

    list.addEventListener('drop', async e => {
      e.preventDefault();
      list.classList.remove('drag-over');
      const toCol = list.dataset.col;

      let payload;
      try { payload = JSON.parse(e.dataTransfer.getData('text/plain')); } catch { return; }
      const { id, from } = payload;
      if (!id) return;

      const taskIndex = data[from].findIndex(t => t.id === id);
      if (taskIndex === -1) return;
      const [task] = data[from].splice(taskIndex, 1);

      // Determine drop position
      const cards = [...list.querySelectorAll('.card:not(.dragging)')];
      let insertIndex = data[toCol].length;
      for (let i = 0; i < cards.length; i++) {
        const rect = cards[i].getBoundingClientRect();
        if (e.clientY < rect.top + rect.height / 2) {
          insertIndex = i;
          break;
        }
      }

      data[toCol].splice(insertIndex, 0, task);
      await save(data);
      renderAll();
    });
  });

  // Add task buttons
  document.querySelectorAll('.add-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const column = btn.closest('.column');
      const colKey = column.dataset.col;

      // Don't open if already open
      if (column.querySelector('.add-form')) return;

      const form = document.createElement('div');
      form.className = 'add-form';

      const textarea = document.createElement('textarea');
      textarea.rows = 2;
      textarea.placeholder = 'Enter task...';

      const actions = document.createElement('div');
      actions.className = 'form-actions';

      const addBtn = document.createElement('button');
      addBtn.className = 'btn btn-primary';
      addBtn.textContent = 'Add';

      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'btn btn-ghost';
      cancelBtn.textContent = 'Cancel';

      async function submit() {
        const text = textarea.value.trim();
        if (!text) { form.remove(); return; }
        const task = { id: uid(), text };
        data[colKey].push(task);
        await save(data);
        const list = column.querySelector('.task-list');
        const empty = list.querySelector('.empty-state');
        if (empty) empty.remove();
        list.appendChild(createCard(task, colKey));
        updateCounts();
        form.remove();
      }

      textarea.addEventListener('keydown', async e => {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); await submit(); }
        if (e.key === 'Escape') form.remove();
      });

      addBtn.addEventListener('click', submit);
      cancelBtn.addEventListener('click', () => form.remove());

      actions.appendChild(addBtn);
      actions.appendChild(cancelBtn);
      form.appendChild(textarea);
      form.appendChild(actions);
      column.appendChild(form);
      textarea.focus();
    });
  });

  renderAll();
})();
</script>
</body>
</html>
